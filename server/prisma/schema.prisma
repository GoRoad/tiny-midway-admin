// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// datasource db {
//   provider = "sqlite"
//   url      = env("DATABASE_URL")
// }
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CasbinRule {
  id    Int     @id @default(autoincrement())
  ptype String
  v0    String?
  v1    String?
  v2    String?
  v3    String?
  v4    String?
  v5    String?

  @@map("casbin_rule")
}

model User {
  id               Int       @id @default(autoincrement())
  email            String?
  phone            String?
  nickName         String
  address          String?
  system           Boolean?  @default(false)
  passwordVersion  Int       @default(1)
  gender           Int?
  avatar           String?   @default("https://s1.imagehub.cc/images/2024/10/22/d99f96eaf4ec45e7b2f5eb19c66303d6.gif")
  username         String    @unique
  password         String // 添加密码字段
  createTime       DateTime  @default(now())
  updateTime       DateTime  @updatedAt
  // 关联表
  posts            Post[]    @relation("Posts")
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  @@map("users")
}

model Message {
  id         Int      @id @default(autoincrement())
  content    String // 消息内容
  senderId   Int // 发送者 ID
  receiverId Int // 接收者 ID
  isRead     Boolean  @default(false) // 是否已读
  createTime DateTime @default(now()) // 发送时间
  updateTime DateTime @updatedAt
  // 关联关系
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@map("messages")
}

model Post {
  id         Int      @id @default(autoincrement())
  title      String
  content    String?
  published  Boolean  @default(false)
  authorId   Int
  createTime DateTime @default(now())
  updateTime DateTime @updatedAt

  author User @relation("Posts", fields: [authorId], references: [id])

  @@map("post")
}

model Demo {
  id         Int      @id @default(autoincrement())
  name       String
  gender     Int
  desc       String?
  createTime DateTime @default(now())
  updateTime DateTime @updatedAt

  @@map("demo")
}

model Department {
  id         Int          @id @default(autoincrement())
  name       String
  parentId   Int?         @map("parent_id")
  parent     Department?  @relation("DepartmentToDepartment", fields: [parentId], references: [id])
  children   Department[] @relation("DepartmentToDepartment")
  roles      Role[]       @relation("DepartmentRole")
  createTime DateTime     @default(now())
  updateTime DateTime     @updatedAt

  @@map("departments")
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String
  code        String
  system      Boolean?     @default(false)
  departments Department[] @relation("DepartmentRole")
  createTime  DateTime     @default(now())
  updateTime  DateTime     @updatedAt

  @@map("roles")
}

model Resource {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   @unique
  type        String   @default("MENU")
  parentId    Int?     @map("parent_id")
  path        String?
  redirect    String?
  icon        String?
  component   String?
  layout      String?
  keepAlive   Boolean?
  method      String?
  description String?
  show        Boolean  @default(true)
  enable      Boolean  @default(true)
  order       Int

  createTime DateTime @default(now())
  updateTime DateTime @updatedAt

  parent   Resource?  @relation("MenuToMenu", fields: [parentId], references: [id])
  children Resource[] @relation("MenuToMenu")

  @@map("resource")
}

model Dict {
  id         Int      @id @default(autoincrement())
  name       String
  code       String
  json       String
  remark     String?
  enabled    Boolean
  createTime DateTime @default(now())
  updateTime DateTime @updatedAt

  @@map("dict")
}

model FileCategory {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  createTime DateTime @default(now())
  updateTime DateTime @updatedAt
  system     Boolean  @default(false)

  files File[] // 关联到 File 表

  @@map("file_category")
}

model File {
  id         Int     @id @default(autoincrement())
  fileName   String // 文件名
  filePath   String // 文件路径
  mimeType   String // 文件 MIME 类型
  size       Int // 文件大小（字节）
  categoryId Int     @default(1) // 文件分类
  source     String // 上传来源local、cos、alioss
  userId     Int // 上传者 ID（可选）
  remark     String? // 备注（可选）

  createTime DateTime     @default(now()) // 上传时间
  updateTime DateTime     @updatedAt
  category   FileCategory @relation(fields: [categoryId], references: [id])

  @@map("file")
}

model AIModelConfig {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  type        String
  subType     Int[]    @default([])
  apiKey      String
  model       String
  temperature Float?
  maxTokens   Int?
  baseURL     String
  createTime  DateTime @default(now())
  updateTime  DateTime @updatedAt

  aiBotModel   AIBot[] @relation("AIBotAIModel")
  aiBotModelEm AIBot[] @relation("AIBotAIModelEm")

  @@map("ai_model_config")
}

model WxUser {
  id         Int       @id @default(autoincrement())
  alias      String?
  mobile     String?
  nickName   String?
  headImgUrl String?
  uin        String?
  status     Int // 0离线 1在线
  wxId       String    @unique
  appId      String // 登录设备id
  loginAt    DateTime? // 登录时间
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  aiBot AIBot? @relation("AIBotWxUsers")

  @@map("wx_user")
}

model GeweConfig {
  id        Int       @id
  baseAPI   String
  fileAPI   String
  tinyAPI   String
  CheckAt   DateTime? // Gewe接口验证时间
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("gewe_config")
}

// 智能机器人
model AIBot {
  id            Int      @id @default(autoincrement())
  name          String // 智能体名称
  description   String? // 简介，可选
  prompt        String? // 人设与回复逻辑，可选
  agentPrompt   String? // 智能体逻辑
  plugins       String[] @default([]) // 插件id列表，默认为空数组
  useDataSource Boolean? // 是否有权存取聊天记录
  useAgent      Boolean  @default(false) // 是否使用智能体

  singleChatPrefix String? // 私聊触发机器人的文本信息前缀
  singleListMode   Int // 私聊名单名单模式 1 黑名单 2 白名单
  singleListId     String[] // 私聊名单

  groupChatPrefix String? // 群聊触发机器人的文本信息前缀
  groupListMode   Int // 群聊名单名单模式 1 黑名单 2 白名单
  groupListId     String[] // 群聊名单

  // 关联表
  workflow   Workflow?      @relation("AIBotWorkflows", fields: [workflowId], references: [id])
  workflowId Int?
  // 关联工具
  tools      Tool[]         @relation("AIBotTool")
  // 关联一个微信号
  wx         WxUser?        @relation("AIBotWxUsers", fields: [wxId], references: [wxId])
  wxId       String?        @unique
  // 关联对话模型
  model      AIModelConfig? @relation("AIBotAIModel", fields: [modelId], references: [id])
  modelId    Int?
  // 关联嵌入模型
  emModel    AIModelConfig? @relation("AIBotAIModelEm", fields: [emModelId], references: [id])
  emModelId  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_bot")
}

// 工作流，待用
model Workflow {
  id          Int      @id @default(autoincrement())
  name        String // 工作流名称
  description String? // 简介，可选
  prompt      String? // 提示词
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  aiBot AIBot[] @relation("AIBotWorkflows")

  @@map("workflow")
}

// 工具，供ai调用
model Tool {
  id          Int      @id @default(autoincrement())
  name        String // 工具名称
  funcName    String // 函数名，英文
  description String // 简介
  code        String // 代码
  permissions String[] @default([]) // 权限列表
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  AIBot AIBot[] @relation("AIBotTool")

  @@map("tool")
}

model WxContact {
  id              String   @id @db.VarChar(50)
  nickName        String?  @db.VarChar(50)
  pyInitial       String?  @db.VarChar(50)
  sex             Int?
  bigHeadImgUrl   String?
  smallHeadImgUrl String?
  country         String?  @db.VarChar(20)
  province        String?  @db.VarChar(20)
  city            String?  @db.VarChar(20)
  createTime      DateTime @default(now())
  updateTime      DateTime @updatedAt

  messagesSent     WxMessage[] @relation("Sender")
  messagesReceived WxMessage[] @relation("Receiver")
  // 用户参与的群组
  groups           WxGroup[]   @relation("UserGroups")

  @@map("wx_contact")
}

model WxGroup {
  id              String   @id @db.VarChar(50)
  nickName        String?  @db.VarChar(50)
  pyInitial       String?  @db.VarChar(50)
  chatRoomNotify  Int?
  chatRoomOwner   String?  @db.VarChar(50)
  smallHeadImgUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contacts WxContact[] @relation("UserGroups")
  messages WxMessage[] @relation("GroupMessage")

  @@map("wx_group")
}

model WxMessage {
  id          String                 @id
  appId       String                 @db.VarChar(50)
  wxId        String                 @db.VarChar(50)
  groupId     String?                @db.VarChar(50)
  type        Int
  fromId      String                 @db.VarChar(50)
  toId        String                 @db.VarChar(50)
  content     String
  documents   Unsupported("vector")?
  pushContent String?
  postTime    DateTime
  createTime  DateTime               @default(now())
  updateTime  DateTime               @updatedAt

  sender   WxContact @relation("Sender", fields: [fromId], references: [id])
  receiver WxContact @relation("Receiver", fields: [toId], references: [id])

  group WxGroup? @relation("GroupMessage", fields: [groupId], references: [id])

  @@index([wxId])
  @@index([fromId])
  @@map("wx_message")
}
